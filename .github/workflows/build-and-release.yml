name: Build and Release

# æ­¤å·¥ä½œæµåœ¨ GitHub Actions runner ä¸Šç›´æ¥æ„å»º Android APK
# ä¸ä¾èµ– EAS Build äº‘æœåŠ¡ï¼ŒèŠ‚çœå…è´¹æ„å»ºæ¬¡æ•°

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build (use [skip build] in commit message)'
        required: false
        default: 'false'

jobs:
  build-and-release:
    name: Build APK and Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼ŒæŸäº›æ“ä½œå¯èƒ½éœ€è¦

      - name: Check if build should be skipped
        id: check_skip
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"[skip build]"* ]] || [[ "${{ github.event.inputs.skip_build }}" == "true" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "â­ï¸ Build skipped due to [skip build] in commit message or manual skip"
            exit 0
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check_skip.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_skip.outputs.skip != 'true'
        run: npm ci

      - name: Setup Java
        if: steps.check_skip.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'  # ç¼“å­˜ Gradle ä¾èµ–

      - name: Setup Android SDK
        if: steps.check_skip.outputs.skip != 'true'
        uses: android-actions/setup-android@v3

      - name: Cache Gradle dependencies
        if: steps.check_skip.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Android build
        if: steps.check_skip.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: |
            android/app/build
            android/build
          key: ${{ runner.os }}-android-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-android-build-

      - name: Run expo prebuild
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          echo "Generating native Android project..."
          
          # æ£€æŸ¥ android ç›®å½•å’Œ gradlew æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          NEED_PREBUILD=false
          
          if [ ! -d "android" ]; then
            echo "ğŸ“¦ android directory not found, need prebuild"
            NEED_PREBUILD=true
          elif [ ! -f "android/gradlew" ]; then
            echo "âš ï¸ gradlew not found, need prebuild"
            NEED_PREBUILD=true
          elif [ "package.json" -nt "android" ] || [ "app.json" -nt "android" ]; then
            echo "ğŸ“¦ package.json or app.json changed, need prebuild"
            NEED_PREBUILD=true
          else
            echo "âœ… Android project exists and appears up to date"
          fi
          
          if [ "$NEED_PREBUILD" = "true" ]; then
            echo "ğŸ“¦ Running expo prebuild..."
            npx expo prebuild --platform android --clean
            
            # éªŒè¯ prebuild ç»“æœ
            if [ ! -d "android" ]; then
              echo "âŒ Error: android directory not created after prebuild"
              exit 1
            fi
            
            if [ ! -f "android/gradlew" ]; then
              echo "âŒ Error: gradlew not found after prebuild"
              echo "Listing android directory contents:"
              ls -la android/ || true
              echo ""
              echo "Checking for gradle wrapper:"
              find android -name "gradlew" -type f 2>/dev/null || echo "gradlew not found"
              exit 1
            fi
          fi
          
          # æœ€ç»ˆéªŒè¯
          if [ ! -f "android/gradlew" ]; then
            echo "âŒ Error: gradlew still not found after all checks"
            exit 1
          fi
          
          echo "âœ… Android project ready"
          echo "  gradlew path: android/gradlew"
          echo "  gradlew exists: $(test -f android/gradlew && echo 'yes' || echo 'no')"

      - name: Setup Android Keystore
        if: steps.check_skip.outputs.skip != 'true'
        id: setup_keystore
        run: |
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "âš ï¸ Warning: ANDROID_KEYSTORE_BASE64 not set, building unsigned APK"
            echo "unsigned=true" >> $GITHUB_OUTPUT
          else
            echo "Setting up signing keystore..."
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/qingbu-release-key.jks
            echo "unsigned=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Gradle Signing
        if: steps.check_skip.outputs.skip != 'true' && steps.setup_keystore.outputs.unsigned != 'true'
        run: |
          cd android
          cat >> app/build.gradle << EOF

          android {
              signingConfigs {
                  release {
                      storeFile file('../qingbu-release-key.jks')
                      storePassword '${{ secrets.ANDROID_KEYSTORE_PASSWORD }}'
                      keyAlias '${{ secrets.ANDROID_KEY_ALIAS }}'
                      keyPassword '${{ secrets.ANDROID_KEY_PASSWORD }}'
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
          echo "âœ… Signing configuration added"

      - name: Build APK
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          # éªŒè¯ gradlew å­˜åœ¨
          if [ ! -f "android/gradlew" ]; then
            echo "âŒ Error: gradlew not found"
            exit 1
          fi
          
          cd android
          echo "Building Release APK..."
          chmod +x gradlew
          
          # éªŒè¯ gradlew å¯æ‰§è¡Œ
          if [ ! -x "gradlew" ]; then
            echo "âŒ Error: gradlew is not executable"
            exit 1
          fi
          
          # ä½¿ç”¨æ„å»ºç¼“å­˜å’Œå¹¶è¡Œæ„å»ºåŠ é€Ÿ
          ./gradlew assembleRelease --no-daemon --build-cache --parallel
          
          if [ ! -f "app/build/outputs/apk/release/app-release.apk" ]; then
            echo "âŒ Error: APK not found after build"
            exit 1
          fi
          
          APK_SIZE=$(ls -lh app/build/outputs/apk/release/app-release.apk | awk '{print $5}')
          echo "âœ… APK built successfully"
          echo "  Size: $APK_SIZE"
          echo "  Path: app/build/outputs/apk/release/app-release.apk"

      - name: Copy APK to workspace root
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          cp android/app/build/outputs/apk/release/app-release.apk ./qingbu.apk
          APK_SIZE=$(ls -lh ./qingbu.apk | awk '{print $5}')
          echo "âœ… APK copied to workspace root"
          echo "  File: qingbu.apk"
          echo "  Size: $APK_SIZE"

      - name: Get version from CHANGELOG.md
        if: steps.check_skip.outputs.skip != 'true'
        id: get_version
        run: |
          # ä» CHANGELOG.md è¯»å–æœ€æ–°ç‰ˆæœ¬å·ï¼ˆæ ¼å¼ï¼š## [x.y.z] æˆ– ## [x.y.z] - YYYY-MM-DDï¼‰
          # è·³è¿‡ [Unreleased]ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå·²å‘å¸ƒçš„ç‰ˆæœ¬
          VERSION=$(grep -E "^## \[[0-9]+\.[0-9]+\.[0-9]+\]" CHANGELOG.md | head -1 | sed -E 's/^## \[([0-9]+\.[0-9]+\.[0-9]+)\].*/\1/' || echo "")
          
          # å¦‚æœ CHANGELOG.md ä¸­æ²¡æœ‰ç‰ˆæœ¬å·ï¼Œå°è¯•ä» app.json è¯»å–ï¼ˆå‘åå…¼å®¹ï¼‰
          if [ -z "$VERSION" ]; then
            echo "âš ï¸ Warning: æœªåœ¨ CHANGELOG.md ä¸­æ‰¾åˆ°ç‰ˆæœ¬å·ï¼Œä» app.json è¯»å–"
            VERSION=$(node -p "require('./app.json').expo.version" 2>/dev/null || echo "")
          fi
          
          if [ -z "$VERSION" ]; then
            echo "âŒ Error: æ— æ³•è·å–ç‰ˆæœ¬å·"
            echo "è¯·ç¡®ä¿ CHANGELOG.md ä¸­åŒ…å«ç‰ˆæœ¬å·ï¼Œæ ¼å¼ï¼š## [x.y.z]"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version: $VERSION (from CHANGELOG.md)"

      - name: Extract changelog for version
        if: steps.check_skip.outputs.skip != 'true'
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          CHANGELOG_FILE="CHANGELOG.md"
          
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "âš ï¸ Warning: CHANGELOG.md not found, using commit message"
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "### ğŸ“ å˜æ›´" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æå–å¯¹åº”ç‰ˆæœ¬çš„å˜æ›´è¯´æ˜
          # æŸ¥æ‰¾ä» "## [ç‰ˆæœ¬å·]" åˆ°ä¸‹ä¸€ä¸ª "## [" ä¹‹é—´çš„å†…å®¹
          awk -v version="$VERSION" '
            BEGIN { found=0; in_section=0; output="" }
            /^## \[Unreleased\]/ { 
              # å¦‚æœæŸ¥æ‰¾çš„æ˜¯ Unreleasedï¼Œç›´æ¥ä½¿ç”¨
              if (version == "Unreleased") {
                in_section=1
                found=1
                next
              }
            }
            /^## \[' version '\]/ { 
              in_section=1
              found=1
              next
            }
            /^## \[/ && in_section==1 && found==1 { 
              # é‡åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜ï¼Œåœæ­¢
              in_section=0
              exit
            }
            in_section==1 { 
              if (found==1) {
                # è·³è¿‡ç‰ˆæœ¬æ ‡é¢˜è¡Œå’Œæ—¥æœŸè¡Œï¼ˆæ ¼å¼ï¼š- YYYY-MM-DDï¼‰
                if (!/^## \[/ && !/^- [0-9]{4}-[0-9]{2}-[0-9]{2}$/ && !/^$/) {
                  output=output $0 "\n"
                }
              }
            }
            END {
              if (found==1 && output!="") {
                print output
              }
            }
          ' "$CHANGELOG_FILE" > changelog_section.txt
          
          # å¦‚æœæ‰¾åˆ°äº†å˜æ›´è¯´æ˜ï¼Œä½¿ç”¨å®ƒ
          if [ -s changelog_section.txt ]; then
            CHANGELOG_CONTENT=$(cat changelog_section.txt)
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "âœ… Extracted changelog for version $VERSION from CHANGELOG.md"
          else
            echo "âš ï¸ Warning: No changelog entry found for version $VERSION in CHANGELOG.md"
            echo "Using commit message as fallback"
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "### ğŸ“ å˜æ›´" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        if: steps.check_skip.outputs.skip != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}-${{ github.sha }}
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## è½»ç°¿ v${{ steps.get_version.outputs.version }}
            
            ### æ„å»ºä¿¡æ¯
            - Commit: `${{ github.sha }}`
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æ„å»ºæ–¹å¼: GitHub Actions æœ¬åœ°æ„å»º
            
            ### ä¸‹è½½
            ç‚¹å‡»ä¸‹æ–¹ä¸‹è½½ APK æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚
            
            ### å˜æ›´è¯´æ˜
            
            ${{ steps.release_notes.outputs.release_notes }}
            
            ---
            
            ğŸ“ å®Œæ•´å˜æ›´æ—¥å¿—è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          files: |
            qingbu.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          echo "âœ… Release created successfully!"
          echo ""
          echo "ğŸ“± Release Information:"
          echo "  Version: v${{ steps.get_version.outputs.version }}"
          echo "  Tag: v${{ steps.get_version.outputs.version }}-${{ github.sha }}"
          echo "  APK: qingbu.apk"
          echo ""
          echo "ğŸ”— View release: https://github.com/${{ github.repository }}/releases"
